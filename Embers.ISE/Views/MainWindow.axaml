<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:Embers.ISE.ViewModels"
        xmlns:ae="clr-namespace:AvaloniaEdit;assembly=AvaloniaEdit"
        xmlns:controls="clr-namespace:Embers.ISE.Controls"
        xmlns:behaviors="clr-namespace:Embers.ISE.Behaviors"
        xmlns:models="clr-namespace:Embers.ISE.Models"
        xmlns:conv="clr-namespace:Embers.ISE.Converters"
        x:Class="Embers.ISE.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Width="1100" Height="750"
        Title="Embers ISE"
        Icon="avares://Embers.ISE/Assets/icon.ico"
        Background="#1E1E1E"
        KeyDown="OnWindowKeyDown"
        mc:Ignorable="d">

  <Window.DataContext>
    <vm:MainWindowViewModel/>
  </Window.DataContext>

  <Window.Resources>
    <conv:EmptyToNullConverter x:Key="EmptyToNullConverter"/>
    <conv:BoolToBrushConverter x:Key="TabSelectedBackground"
                               TrueBrush="#4B4B50"
                               FalseBrush="#3E3E42"/>
    <conv:BoolToBrushConverter x:Key="TabUnderlineBrush"
                               TrueBrush="#F5F5F5"
                               FalseBrush="#6B6B6B"/>
    <conv:PathToFileNameConverter x:Key="PathToFileNameConverter"/>
    <conv:PanelToggleTextConverter x:Key="PanelToggleTextConverter"/>
  </Window.Resources>

  <Window.Styles>
    <Style Selector="TextBlock.ToolbarIcon">
      <Setter Property="Width" Value="18"/>
      <Setter Property="TextAlignment" Value="Center"/>
    </Style>
  </Window.Styles>

  <DockPanel>
    <!-- Toolbar -->
    <Border DockPanel.Dock="Top" 
            Background="#2D2D30"
            Padding="8,4">
      <StackPanel Orientation="Horizontal" Spacing="4">
        <Button Command="{Binding NewCommand}" Padding="8,4" Background="#2E7D32" ToolTip.Tip="New script">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <TextBlock Text="ï¼‹" Classes="ToolbarIcon" Foreground="#FFFFFF"/>
          </StackPanel>
        </Button>
        <Button Command="{Binding ClearEditorCommand}" Padding="8,4" ToolTip.Tip="Clear editor">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <TextBlock Text="ðŸ—˜" Classes="ToolbarIcon" Foreground="#98FB98"/>
          </StackPanel>
        </Button>        
        <Button Height="30" Command="{Binding CloseAllTabsCommand}" Padding="8,4" ToolTip.Tip="Close all tabs">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <TextBlock Text="x" Classes="ToolbarIcon" Foreground="#E05A5A"/>
          </StackPanel>
        </Button>
        <Button Command="{Binding OpenCommand}" Padding="8,4" ToolTip.Tip="Open script">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <TextBlock Text="ðŸ“‚ï¸Ž" Classes="ToolbarIcon" Foreground="#F2C94C"/>
          </StackPanel>
        </Button>
        <Button Command="{Binding SaveCommand}" Padding="8,4" ToolTip.Tip="Save script">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <TextBlock Text="ðŸ’¾ï¸Ž" Classes="ToolbarIcon" Foreground="#87CEEB"/>
          </StackPanel>
        </Button>
        <Button Command="{Binding AddReferenceCommand}" Padding="8,4" ToolTip.Tip="Add DLL reference">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <TextBlock Text="ðŸ“¦ï¸Ž" Classes="ToolbarIcon" Foreground="#F2C94C"/>
          </StackPanel>
        </Button>
        <Separator Width="1" Height="20" Background="#3E3E42"/>
        <Button Command="{Binding RunCommand}" Padding="8,4" ToolTip.Tip="Run (F5)">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <TextBlock Text="â–¶ï¸Ž" Classes="ToolbarIcon" Foreground="#55C65A"/>
            <TextBlock Text="(F5)"/>
          </StackPanel>
        </Button>
        <!--<Button Command="{Binding RunWithTraceCommand}" Padding="8,4" ToolTip.Tip="Run with inference trace">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <TextBlock Text="â–¶" Classes="ToolbarIcon" Foreground="#55C65A"/>
            <TextBlock Text="Trace"/>
          </StackPanel>
        </Button>-->
        <Button Click="OnRunSelection" Padding="8,4" ToolTip.Tip="Run selection (F6)">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <TextBlock Text="â–¶" Classes="ToolbarIcon" Foreground="#55C65A"/>
            <TextBlock Text="(F6)"/>
          </StackPanel>
        </Button>
        <Button Command="{Binding StopCommand}" Padding="8,4" ToolTip.Tip="Stop execution">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <TextBlock Text="â– " Classes="ToolbarIcon" Foreground="#E05A5A"/>
          </StackPanel>
        </Button>
        <Separator Width="1" Height="20" Background="#3E3E42"/>
        <Button Command="{Binding HelpCommand}" Padding="8,4" Background="#2F6BFF" ToolTip.Tip="Help">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <TextBlock Text="â“ï¸Ž" Classes="ToolbarIcon" Foreground="#FFFFFF"/>
          </StackPanel>
        </Button>
        <Button Click="OnOpenGitHub" Padding="8,4" Background="#2F6BFF" ToolTip.Tip="GitHub">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <TextBlock Text="ðŸŒ" Classes="ToolbarIcon" Foreground="#FFFFFF"/>
          </StackPanel>
        </Button>
      </StackPanel>
    </Border>

    <Grid>
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*"/>
        <ColumnDefinition Width="22"/>
        <ColumnDefinition Width="{Binding RightPanelWidth}"/>
      </Grid.ColumnDefinitions>
      <!-- Left: editor + console -->
      <Grid Column="0" RowDefinitions="*,Auto,220">
        <!-- Editor Tabs -->
        <Grid Grid.Row="0" RowDefinitions="Auto,*">
          <DockPanel Background="#2D2D30" Height="32">
            <Button DockPanel.Dock="Left"
                    Width="24"
                    Height="24"
                    Margin="4,3"
                    Content="&lt;"
                    FontSize="8"
                    Click="OnScrollTabsLeft"/>
            <Button DockPanel.Dock="Right"
                    Width="24"
                    Height="24"
                    Margin="4,3"
                    Content="&gt;"
                    FontSize="8"
                    Click="OnScrollTabsRight"/>
            <ScrollViewer Name="TabScroll"
                          Height="30"
                          HorizontalScrollBarVisibility="Hidden"
                          VerticalScrollBarVisibility="Disabled"
                          Margin="4,0"
                          VerticalAlignment="Center">
              <ItemsControl ItemsSource="{Binding Tabs}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <StackPanel Orientation="Horizontal"/>
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate x:DataType="models:DocumentTab">
                    <Border Background="{Binding IsSelected, Converter={StaticResource TabSelectedBackground}}"
                            Padding="8,4,8,0"
                            Margin="2,3"
                            CornerRadius="3"
                            PointerPressed="OnTabHeaderPointerPressed">
                      <Grid RowDefinitions="Auto,2">
                        <DockPanel Grid.Row="0">
                          <TextBlock Text="{Binding Title}"
                                     FontSize="10"
                                     VerticalAlignment="Center"
                                     Margin="0,0,8,0"/>
                          <Button Content="x"
                                  Padding="4,0"
                                  Background="#C62828"
                                  Foreground="#FFFFFF"
                                  x:CompileBindings="False"
                                  FontSize="10"
                                  Command="{Binding DataContext.CloseTabCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                  CommandParameter="{Binding}"/>
                        </DockPanel>
                        <Border Grid.Row="1" Height="1" Margin="-7,2,-7,0"
                                Background="{Binding IsSelected, Converter={StaticResource TabUnderlineBrush}}"/>
                      </Grid>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>
          </DockPanel>

          <ContentControl Grid.Row="1"
                          Content="{Binding SelectedTab}">
            <ContentControl.ContentTemplate>
              <DataTemplate x:DataType="models:DocumentTab">
                <ae:TextEditor ShowLineNumbers="True"
                               FontFamily="Consolas, Courier New, monospace"
                               FontSize="14"
                               WordWrap="False"
                               IsReadOnly="False"
                               HorizontalScrollBarVisibility="Auto"
                               VerticalScrollBarVisibility="Auto"
                               behaviors:TextEditorBindingBehavior.Text="{Binding Text, Mode=TwoWay}"
                               Loaded="OnEditorLoaded"
                               Unloaded="OnEditorUnloaded"
                               GotFocus="OnEditorGotFocus">
                  <ae:TextEditor.ContextMenu>
                  <ContextMenu>
                    <MenuItem Header="Cut" Click="OnEditorCut"/>
                    <MenuItem Header="Copy" Click="OnEditorCopy"/>
                    <MenuItem Header="Paste" Click="OnEditorPaste"/>
                    <MenuItem Header="Select All" Click="OnEditorSelectAll"/>
                    <Separator/>
                    <MenuItem Header="Format Document" Click="OnFormatDocument"/>
                  </ContextMenu>
                </ae:TextEditor.ContextMenu>
              </ae:TextEditor>
              </DataTemplate>
            </ContentControl.ContentTemplate>
          </ContentControl>
        </Grid>

        <GridSplitter Grid.Row="1" 
                      Height="6" 
                      HorizontalAlignment="Stretch" 
                      Background="#3E3E42"/>

        <!-- Console -->
      <ScrollViewer Grid.Row="2"
                    Name="ConsoleScroll"
                    HorizontalScrollBarVisibility="Auto"
                    VerticalScrollBarVisibility="Auto"
                    Background="#1E1E1E">
          <controls:ColorizedConsole Name="Console" />
        </ScrollViewer>
      </Grid>

      <Button Grid.Column="1"
              HorizontalAlignment="Right"
              VerticalAlignment="Stretch"
              Width="22"
              Padding="0"
              Background="#2D2D30"
              BorderBrush="#3E3E42"
              BorderThickness="0,0,1,0"
              HorizontalContentAlignment="Center"
              VerticalContentAlignment="Center"
              Command="{Binding ToggleRightPanelCommand}"
              Content="{Binding IsRightPanelVisible, Converter={StaticResource PanelToggleTextConverter}}"/>

      <!-- Right: function panel -->
      <Border Grid.Column="2"
              IsVisible="{Binding IsRightPanelVisible}"
              Background="#252526"
              BorderBrush="#3E3E42"
              BorderThickness="1,0,0,0">
        <DockPanel>
          <StackPanel DockPanel.Dock="Top" Margin="8" Spacing="8">
            <TextBlock Text="Security" Foreground="#D0D0D0"/>
            <ComboBox ItemsSource="{Binding SecurityModes}"
                      SelectedItem="{Binding SelectedSecurityMode}"/>
            <Expander Header="Whitelist"
                      IsExpanded="True"
                      IsVisible="{Binding IsWhitelistMode}">
              <StackPanel Spacing="6">
                <TextBlock Text="Allow types or namespaces (use 'My.Namespace.*')."
                           Foreground="#A0A0A0"
                           FontSize="10"/>
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <TextBox Width="190"
                           FontSize="10"
                           Text="{Binding NewWhitelistEntry}"
                           Watermark="MyApp.Type or MyApp.Namespace.*"/>
                  <Button Content="Add" Command="{Binding AddWhitelistEntryCommand}" Padding="10,4"/>
                </StackPanel>
                <ListBox ItemsSource="{Binding WhitelistEntries}"
                         SelectedItem="{Binding SelectedWhitelistEntry}"
                         Height="120"/>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="6">
                  <Button Content="Remove" Command="{Binding RemoveWhitelistEntryCommand}" Padding="10,4"/>
                  <Button Content="Clear" Command="{Binding ClearWhitelistCommand}" Padding="10,4"/>
                </StackPanel>
              </StackPanel>
            </Expander>
          </StackPanel>

          <TabControl FontSize="12">
            <TabItem Header="Std Lib" FontSize="12">
              <DockPanel>
                <TextBox DockPanel.Dock="Top"
                         Margin="8,8,8,4"
                         Watermark="Search stdlib..."
                         Text="{Binding StdLibFilterText, UpdateSourceTrigger=PropertyChanged}"/>
                <ListBox Name="StdLibList" ItemsSource="{Binding StdLibFunctions}">
                  <ListBox.ItemTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding Name}"
                                 PointerPressed="OnFunctionItemPointerPressed"
                                 ToolTip.Tip="{Binding Comment, Converter={StaticResource EmptyToNullConverter}}"/>
                    </DataTemplate>
                  </ListBox.ItemTemplate>
                </ListBox>
              </DockPanel>
            </TabItem>
            <TabItem Header="Host" FontSize="12">
              <DockPanel>
                <TextBox DockPanel.Dock="Top"
                         Margin="8,8,8,4"
                         Watermark="Search host..."
                         Text="{Binding HostFilterText, UpdateSourceTrigger=PropertyChanged}"/>
                <ListBox Name="HostList" ItemsSource="{Binding HostFunctions}">
                  <ListBox.ItemTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding Name}"
                                 PointerPressed="OnFunctionItemPointerPressed"
                                 ToolTip.Tip="{Binding Comment, Converter={StaticResource EmptyToNullConverter}}"/>
                    </DataTemplate>
                  </ListBox.ItemTemplate>
                </ListBox>
              </DockPanel>
            </TabItem>
            <TabItem Header="References" FontSize="12">
              <ListBox Name="ReferenceList" ItemsSource="{Binding ReferenceAssemblies}">
                <ListBox.ItemTemplate>
                  <DataTemplate x:DataType="{x:Null}">
                    <TextBlock Text="{Binding Converter={StaticResource PathToFileNameConverter}}"
                               ToolTip.Tip="{Binding}">
                      <TextBlock.ContextMenu>
                        <ContextMenu x:CompileBindings="False">
                          <MenuItem Header="Remove"
                                    Command="{Binding DataContext.RemoveReferenceCommand, ElementName=ReferenceList}"
                                    CommandParameter="{Binding}"/>
                        </ContextMenu>
                      </TextBlock.ContextMenu>
                    </TextBlock>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
            </TabItem>
          </TabControl>
        </DockPanel>
      </Border>
    </Grid>
  </DockPanel>
</Window>


